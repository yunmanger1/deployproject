#!/bin/bash

pwd=$( readlink -f "$( dirname "$BASH_SOURCE" )" )
if [ ! $1 ]
then
  echo "specify project"
  exit 1
fi
proj=$1

if [ ! $WORK_ROOT ]
then
  echo "init"
  source $pwd/startwork
fi

DEPLOY_DIR=$WORK_ROOT/projects
PROJECT_DIR=$DEPLOY_DIR/$proj
NGINX_CONF=$WORK_ROOT/conf
cd $WORK_ROOT

DESC="Deploy"

cd $WORK_ROOT

set -e
case "$2" in
start)
  echo "Starting $DESC: "
  if [ -e $PROJECT_DIR/etc/nginx.conf ]
  then
    cp $PROJECT_DIR/etc/nginx.conf $NGINX_CONF/$proj.conf
  fi
  if [ -e $PROJECT_DIR/etc/nginx.media ]
  then
    cp $PROJECT_DIR/etc/nginx.media $NGINX_CONF/$proj.media
  fi
  ;;
stop)
  echo "Stopping $DESC: "
  if [ -e $NGINX_CONF/$proj.conf ]
  then
    rm $NGINX_CONF/$proj.conf
  fi
  if [ -e $NGINX_CONF/$proj.media ]
  then
    rm $NGINX_CONF/$proj.media
  fi
  ;;
restart|force-reload)
  echo "Restarting $DESC: "
  if [ -e $PROJECT_DIR/etc/nginx.conf ]
  then
    cp $PROJECT_DIR/etc/nginx.conf $NGINX_CONF/$proj.conf
  fi
  if [ -e $PROJECT_DIR/etc/nginx.media ]
  then
    cp $PROJECT_DIR/etc/nginx.media $NGINX_CONF/$proj.media
  fi
  sleep 2
  if [ -e $NGINX_CONF/$proj.conf ]
  then
    rm $NGINX_CONF/$proj.conf
  fi
  if [ -e $NGINX_CONF/$proj.media ]
  then
    rm $NGINX_CONF/$proj.media
  fi
  ;;
reload)
  echo "Reloading $DESC: "
  cp $PROJECT_DIR/etc/nginx.conf $NGINX_CONF/$proj.conf
  cp $PROJECT_DIR/etc/nginx.media $NGINX_CONF/$proj.media
  ;;
*)
  echo "Usage: {start|stop|restart|reload|force-reload} {project}" >&2
  exit 1
  ;;
esac
exit 0
